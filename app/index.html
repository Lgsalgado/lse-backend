<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reconocimiento Autom√°tico de Se√±as</title>
</head>
<body>
  <h2>Reconocimiento Autom√°tico (Webcam)</h2>
  <video id="video" width="320" height="240" autoplay muted></video>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

  <h3>Traducci√≥n:</h3>
  <pre id="resultado">Esperando movimiento...</pre>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultado = document.getElementById('resultado');
    const ctx = canvas.getContext('2d');

    let frameBuffer = [];
    const maxFrames = 30;
    let isSending = false;

    // Acceder a la c√°mara
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;

      // Comenzar a capturar frames continuamente
      setInterval(() => {
        if (isSending) return;

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
          frameBuffer.push(blob);

          if (frameBuffer.length >= maxFrames) {
            isSending = true;

            // Crear video a partir de los 30 frames
            const videoBlob = new Blob(frameBuffer, { type: 'video/webm' });
            const formData = new FormData();
            formData.append("file", videoBlob, "captura.webm");

            resultado.textContent = "‚è≥ Procesando...";

            fetch("http://localhost:8000/api/procesar", {
              method: "POST",
              body: formData
            })
            .then(res => res.json())
            .then(data => {
              resultado.textContent = `üìù Traducci√≥n: ${data.traduccion}`;
            })
            .catch(() => {
              resultado.textContent = "‚ö†Ô∏è Error al procesar el video";
            })
            .finally(() => {
              frameBuffer = [];
              isSending = false;
            });
          }
        }, "image/webp");
      }, 100); // cada 100ms ‚Üí 30 frames = ~3 segundos
    }).catch(err => {
      alert("Error al acceder a la c√°mara: " + err);
    });
  </script>
</body>
</html>
